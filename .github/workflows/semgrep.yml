name: Semgrep Scan
on: [push, pull_request]

jobs:
  semgrep:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Run Semgrep
        uses: returntocorp/semgrep-action@v1
        with:
          config: auto

      - name: Send Discord Notification
        if: failure() || success()
        run: |
          SUMMARY=$(jq -r '.results | length' semgrep_results.json)
          curl -H "Content-Type: application/json" \
               -X POST \
               -d "{\"content\": \"⚠️ Semgrep found **$SUMMARY** issues in the latest scan.\"}" \
               ${{ secrets.DISCORD_WEBHOOK_URL }}

      # ---------- New Step: Detailed Discord Notification ----------
      - name: Send Detailed Discord Notification
        if: always()
        run: |
          # Install jq if not present
          sudo apt-get update && sudo apt-get install -y jq

          # Count total vulnerabilities
          total_issues=$(jq '.results | length' semgrep_results.json)

          if [ "$total_issues" -eq 0 ]; then
            curl -H "Content-Type: application/json" \
                 -X POST \
                 -d "{\"content\": \"✅ Semgrep scan complete — no vulnerabilities found.\"}" \
                 ${{ secrets.DISCORD_WEBHOOK_URL }}
          else
            # Initialize message
            message="⚠️ Semgrep found *$total_issues* vulnerabilities:\n"

            # Loop safely through each issue
            jq -c '.results[]' semgrep_results.json | while read issue; do
              check_name=$(echo "$issue" | jq -r '.check_id')
              path=$(echo "$issue" | jq -r '.path')
              start_line=$(echo "$issue" | jq -r '.start.line')
              end_line=$(echo "$issue" | jq -r '.end.line')
              description=$(echo "$issue" | jq -r '.extra.message' | cut -c1-500)
              mitigation=$(echo "$issue" | jq -r '.extra.metadata.recommendation // "No mitigation provided"' | cut -c1-500)

              message="$message\n**$check_name**\nFile: $path [$start_line-$end_line]\nDescription: $description\nMitigation: $mitigation\n"
            done

            # Split messages for Discord (max 2000 chars per message)
            echo "$message" | fold -w 1900 -s | while read chunk; do
              curl -H "Content-Type: application/json" \
                   -X POST \
                   -d "{\"content\": \"$chunk\"}" \
                   ${{ secrets.DISCORD_WEBHOOK_URL }}
            done
          fi
